<!DOCTYPE html>
<html lang="zh-CN">
<script src="./js/refreshToken.js"></script>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>借贷 - 极速贷款</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
        }

        body {
            background-color: #f5f5f5;
            color: #333;
            padding-bottom: 60px;
        }

        .welcome-header {
            background: linear-gradient(135deg, #0f4c81, #1a6fb0);
            color: white;
            padding: 15px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .welcome-text {
            font-size: 18px;
            font-weight: bold;
        }

        .filter {
            display: flex;
            background: white;
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
        }

        .filter-item {
            padding: 8px 15px;
            margin-right: 10px;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .filter-item.active {
            background-color: #0f4c81;
            color: white;
        }

        .product-card {
            background: white;
            margin: 15px;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            position: relative;
        }

        .product-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 8px;
            color: #0f4c81;
        }

        .product-info {
            font-size: 14px;
            margin-bottom: 5px;
            color: #666;
        }

        .product-rate {
            color: #e74c3c;
            font-weight: bold;
        }

        .btn {
            background: #0f4c81;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            width: 100%;
            font-size: 16px;
            margin-top: 10px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .btn:hover {
            background: #1a6fb0;
        }

        .product-amount {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #e74c3c;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }

        .card {
            background: white;
            margin: 20px 15px;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            text-align: center;
        }

        .nav {
            /*position: fixed;*/
            /*bottom: 0;*/
            /*left: 0;*/
            /*right: 0;*/
            /*background: white;*/
            /*display: flex;*/
            /*justify-content: space-around;*/
            /*padding: 10px 0;*/
            /*border-top: 1px solid #eee;*/
            /*z-index: 100;*/

            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: space-around;
            background: white;
            border-top: 1px solid #ddd;
            padding: 10px 0;
            z-index: 1000;

        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: #999;
            font-size: 12px;
        }

        .nav-item.active {
            color: #0f4c81;
        }

        .nav-item i {
            font-size: 20px;
            margin-bottom: 3px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .error-message {
            text-align: center;
            padding: 20px;
            color: #e74c3c;
            background: white;
            margin: 15px;
            border-radius: 10px;
        }

        .product-term {
            display: inline-block;
            background: #f0f7ff;
            color: #0f4c81;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
            margin-top: 5px;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
<div class="welcome-header">
    <div class="welcome-text">12:00 借贷</div>
</div>

<!-- 用于筛选的栏 -->
<div class="filter">
    <div class="filter-item active">全部</div>
    <div class="filter-item">个人贷款</div>
    <div class="filter-item">企业贷款</div>
    <div class="filter-item">筛选</div>
</div>

<!-- 产品容器 -->
<div id="products-container">
    <div class="loading">
        <i class="fas fa-spinner fa-spin"></i> 加载中...
    </div>
</div>

<!-- 更多产品（预留接口） -->
<div class="card">
    <button class="btn" style="background: white; color: #0f4c81; border: 1px solid #0f4c81;">
        查看更多产品
    </button>
</div>

<!-- 底部导航栏 -->
<div class="nav">
    <a href="index.html" class="nav-item">
        <i class="fas fa-home"></i>
        <span>首页</span>
    </a>
    <a href="loan.html" class="nav-item active">
        <i class="fas fa-money-bill-wave"></i>
        <span>借贷</span>
    </a>
    <a href="message.html" class="nav-item">
        <i class="fas fa-comment-dots"></i>
        <span>消息</span>
    </a>
    <a href="mine.html" class="nav-item">
        <i class="fas fa-user"></i>
        <span>我的</span>
    </a>
</div>

<script>
    // 更新当前时间
    function updateTime() {
        const now = new Date();
        const hours = now.getHours().toString().padStart(2, '0');
        const minutes = now.getMinutes().toString().padStart(2, '0');
        document.querySelector('.welcome-text').textContent = `${hours}:${minutes} 借贷`;
    }

    // 格式化利率显示
    function formatRate(rate) {
        return (parseFloat(rate) * 100).toFixed(2) + '%';
    }

    // 格式化金额显示
    function formatAmount(amount) {
        const num = parseFloat(amount);
        if (num >= 10000) {
            return (num / 10000).toFixed(1) + '万';
        }
        return num.toLocaleString() + '元';
    }

    // 获取贷款产品数据
    async function fetchLoanProducts() {
        const container = document.getElementById('products-container');

        try {
            // 从localStorage获取token
            const authData = localStorage.getItem('authData');
            if (!authData) {
                throw new Error('未找到认证信息，请重新登录');
            }

            const token = JSON.parse(authData).accessToken;
            if (!token) {
                throw new Error('认证令牌无效，请重新登录');
            }

            // 设置请求头
            const myHeaders = new Headers();
            myHeaders.append("Authorization", token);

            const requestOptions = {
                method: 'GET',
                headers: myHeaders,
                redirect: 'follow'
            };

            // 发送请求
            const response = await fetch("http://115.190.40.44:45444/loan/option", requestOptions);

            if (!response.ok) {
                throw new Error(`请求失败: ${response.status} ${response.statusText}`);
            }

            const result = await response.json();

            // 检查响应是否成功
            if (!result.success) {
                throw new Error(`API错误: ${result.errCode}`);
            }

            // 清空容器并显示产品
            container.innerHTML = '';

            if (!result.products || result.products.length === 0) {
                container.innerHTML = '<div class="error-message">暂无贷款产品</div>';
                return;
            }

            // 生成产品卡片
            result.products.forEach(product => {
                const productCard = document.createElement('div');
                productCard.className = 'product-card';

                // 产品名称
                const title = document.createElement('div');
                title.className = 'product-title';
                title.textContent = product.name;

                // 额度信息
                const amountInfo = document.createElement('div');
                amountInfo.className = 'product-info';
                amountInfo.textContent = `额度 ${formatAmount(product.min_principle)}-${formatAmount(product.max_principle)}`;

                // 利率信息
                const rateInfo = document.createElement('div');
                rateInfo.className = 'product-info';
                rateInfo.innerHTML = `年化利率 <span class="product-rate">${formatRate(product.interest)}起</span>`;

                // 期限信息
                const termInfo = document.createElement('div');
                termInfo.className = 'product-info';

                if (product.min_periods && product.max_periods) {
                    let periodUnit = '个月';
                    if (product.period_type === 'DAY') {
                        periodUnit = '天';
                    } else if (product.period_type === 'YEAR') {
                        periodUnit = '年';
                    }
                    termInfo.textContent = `期限 ${product.min_periods}-${product.max_periods}${periodUnit}`;
                } else {
                    termInfo.textContent = '期限 灵活可选';
                }

                // 逾期利率
                const penaltyInfo = document.createElement('div');
                penaltyInfo.className = 'product-info';
                penaltyInfo.innerHTML = `逾期利率 <span class="product-term">${formatRate(product.penalty)}</span>`;

                // 申请按钮
                const applyBtn = document.createElement('button');
                applyBtn.className = 'btn';
                applyBtn.textContent = '立即申请';
                applyBtn.onclick = function() {
                    // 将完整产品数据编码后传递到申请页面
                    const productData = encodeURIComponent(JSON.stringify(product));
                    window.location.href = `loan_option/loan_application.html?productData=${productData}`;
                };

                // 最高额度标签
                const amountTag = document.createElement('div');
                amountTag.className = 'product-amount';
                amountTag.textContent = formatAmount(product.max_principle);

                // 组装产品卡片
                productCard.appendChild(title);
                productCard.appendChild(amountInfo);
                productCard.appendChild(rateInfo);
                productCard.appendChild(termInfo);
                productCard.appendChild(penaltyInfo);
                productCard.appendChild(applyBtn);
                productCard.appendChild(amountTag);

                container.appendChild(productCard);
            });

        } catch (error) {
            console.error('获取贷款产品失败:', error);
            container.innerHTML = `<div class="error-message">加载失败: ${error.message}</div>`;
        }
    }

    // 页面加载完成后执行
    document.addEventListener('DOMContentLoaded', function() {
        updateTime();
        setInterval(updateTime, 60000);

        // 获取贷款产品数据
        fetchLoanProducts();

        // 筛选功能交互
        const filterItems = document.querySelectorAll('.filter-item');
        filterItems.forEach(item => {
            item.addEventListener('click', () => {
                filterItems.forEach(i => i.classList.remove('active'));
                item.classList.add('active');
                // 预留接口：根据筛选条件加载不同贷款产品
                // 这里可以根据筛选条件重新调用fetchLoanProducts并传递筛选参数
            });
        });
    });
</script>
</body>
</html>