<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>借贷 - 极速贷款</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
        }

        body {
            background-color: #f5f5f5;
            color: #333;
            padding-bottom: 60px;
        }

        .welcome-header {
            background: linear-gradient(135deg, #0f4c81, #1a6fb0);
            color: white;
            padding: 15px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .welcome-text {
            font-size: 18px;
            font-weight: bold;
        }

        .filter {
            display: flex;
            background: white;
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
        }

        .filter-item {
            padding: 8px 15px;
            margin-right: 10px;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .filter-item.active {
            background-color: #0f4c81;
            color: white;
        }

        .product-card {
            background: white;
            margin: 15px;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            position: relative;
        }

        .product-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 8px;
            color: #0f4c81;
        }

        .product-info {
            font-size: 14px;
            margin-bottom: 5px;
            color: #666;
        }

        .product-rate {
            color: #e74c3c;
            font-weight: bold;
        }

        .btn {
            background: #0f4c81;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            width: 100%;
            font-size: 16px;
            margin-top: 10px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .btn:hover {
            background: #1a6fb0;
        }

        .product-amount {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #e74c3c;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }

        .card {
            background: white;
            margin: 20px 15px;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            text-align: center;
        }

        .nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            border-top: 1px solid #eee;
            z-index: 100;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: #999;
            font-size: 12px;
        }

        .nav-item.active {
            color: #0f4c81;
        }

        .nav-item i {
            font-size: 20px;
            margin-bottom: 3px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .error-message {
            text-align: center;
            padding: 20px;
            color: #e74c3c;
            background: white;
            margin: 15px;
            border-radius: 10px;
        }

        .product-term {
            display: inline-block;
            background: #f0f7ff;
            color: #0f4c81;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
            margin-top: 5px;
        }

        /* 贷款详情页样式 */
        .detail-header {
            background: linear-gradient(135deg, #0f4c81, #1a3a5f);
            color: white;
            padding: 20px 15px;
            position: relative;
            border-radius: 0 0 20px 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .detail-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .detail-subtitle {
            font-size: 14px;
            opacity: 0.8;
        }

        .detail-container {
            padding: 15px;
        }

        .form-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .form-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #0f4c81;
            display: flex;
            align-items: center;
        }

        .form-title i {
            margin-right: 8px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            margin-bottom: 8px;
            color: #666;
        }

        .form-input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-input:focus {
            border-color: #0f4c81;
            outline: none;
        }

        .amount-input-container {
            position: relative;
        }

        .amount-input {
            padding-left: 40px;
        }

        .amount-symbol {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 16px;
            color: #333;
        }

        .term-options {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .term-option {
            flex: 1;
            min-width: 80px;
            padding: 10px;
            text-align: center;
            border: 1px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .term-option.active {
            background-color: #0f4c81;
            color: white;
            border-color: #0f4c81;
        }

        .bank-select-container {
            position: relative;
        }

        .bank-select {
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 15px;
        }

        .repayment-card {
            background: linear-gradient(135deg, rgba(15, 76, 129, 0.1), rgba(26, 58, 95, 0.1));
            border: 1px solid rgba(15, 76, 129, 0.2);
        }

        .repayment-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .repayment-item:last-child {
            border-bottom: none;
        }

        .repayment-label {
            color: #666;
        }

        .repayment-value {
            font-weight: bold;
            color: #0f4c81;
        }

        .btn-secondary {
            background: white;
            color: #0f4c81;
            border: 1px solid #0f4c81;
        }

        .tooltip {
            position: relative;
            display: inline-block;
            margin-left: 5px;
            color: #999;
            cursor: help;
        }

        .tooltip-text {
            visibility: hidden;
            width: 200px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
        }

        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        .product-feature {
            display: flex;
            align-items: center;
            margin-top: 5px;
            font-size: 13px;
            color: #666;
        }

        .product-feature i {
            margin-right: 5px;
            color: #0f4c81;
        }
    </style>
    <script src="../js/refreshToken.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
<!-- 产品列表页面 -->
<div id="product-list-page">
    <div class="welcome-header">
        <div class="welcome-text">12:00 借贷</div>
    </div>

    <!-- 用于筛选的栏 -->
    <div class="filter">
        <div class="filter-item active">全部</div>
        <div class="filter-item">个人贷款</div>
        <div class="filter-item">企业贷款</div>
        <div class="filter-item">筛选</div>
    </div>

    <!-- 产品容器 -->
    <div id="products-container">
        <div class="loading">
            <i class="fas fa-spinner fa-spin"></i> 加载中...
        </div>
    </div>

    <!-- 更多产品（预留接口） -->
    <div class="card">
        <button class="btn" style="background: white; color: #0f4c81; border: 1px solid #0f4c81;">
            查看更多产品
        </button>
    </div>

    <!-- 底部导航栏 -->
    <div class="nav">
        <a href="/loan_APP_real/index.html" class="nav-item">
            <i class="fas fa-home"></i>
            <span>首页</span>
        </a>
        <a href="/loan_APP_real/loan.html" class="nav-item active">
            <i class="fas fa-money-bill-wave"></i>
            <span>借贷</span>
        </a>
        <a href="/loan_APP_real/message.html" class="nav-item">
            <i class="fas fa-comment-dots"></i>
            <span>消息</span>
        </a>
        <a href="/loan_APP_real/mine.html" class="nav-item">
            <i class="fas fa-user"></i>
            <span>我的</span>
        </a>
    </div>
</div>

<!-- 贷款详情页面（默认隐藏） -->
<div id="loan-detail-page" style="display: none;">
    <!-- 头部 -->
    <div class="detail-header">
        <div class="detail-title" id="detail-product-name">闪电贷申请</div>
        <div class="detail-subtitle" id="detail-product-desc">极速审批，最快30秒放款</div>
    </div>

    <!-- 主要内容 -->
    <div class="detail-container">
        <!-- 贷款信息表单 -->
        <div class="form-card">
            <div class="form-title">
                <i class="fas fa-money-bill-wave"></i>贷款信息
            </div>

            <div class="form-group">
                <label class="form-label">贷款金额（元）</label>
                <div class="amount-input-container">
                    <span class="amount-symbol">¥</span>
                    <input type="number" id="loanAmount" class="form-input amount-input" placeholder="请输入借款金额" min="1000" step="1000">
                </div>
                <div style="display: flex; justify-content: space-between; margin-top: 5px;">
                    <span style="font-size: 12px; color: #999;" id="min-amount-hint">最低1000元</span>
                    <span style="font-size: 12px; color: #999;" id="max-amount-hint">最高200,000元</span>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">贷款期限</label>
                <div class="term-options" id="term-options-container">
                    <!-- 期限选项将动态生成 -->
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">年化利率</label>
                <input type="text" id="interestRate" class="form-input" value="7.2%" readonly>
            </div>

            <div class="form-group">
                <label class="form-label">还款方式</label>
                <input type="text" id="repayType" class="form-input" value="等额本息" readonly>
            </div>
        </div>

        <!-- 产品特色信息 -->
        <div class="form-card">
            <div class="form-title">
                <i class="fas fa-star"></i>产品特色
            </div>

            <div id="product-features">
                <!-- 产品特色将动态生成 -->
            </div>
        </div>

        <!-- 还款计划 -->
        <div class="form-card repayment-card">
            <div class="form-title">
                <i class="fas fa-calculator"></i>还款计划
            </div>

            <div class="repayment-item">
                <span class="repayment-label">贷款金额</span>
                <span class="repayment-value" id="repaymentAmount">0元</span>
            </div>

            <div class="repayment-item">
                <span class="repayment-label">贷款期限</span>
                <span class="repayment-value" id="repaymentTerm">0个月</span>
            </div>

            <div class="repayment-item">
                <span class="repayment-label">月利率</span>
                <span class="repayment-value" id="monthlyRate">0%</span>
            </div>

            <div class="repayment-item">
                <span class="repayment-label">每月还款额</span>
                <span class="repayment-value" id="monthlyPayment">0元</span>
            </div>

            <div class="repayment-item">
                <span class="repayment-label">总利息</span>
                <span class="repayment-value" id="totalInterest">0元</span>
            </div>

            <div class="repayment-item">
                <span class="repayment-label">总还款额</span>
                <span class="repayment-value" id="totalRepayment">0元</span>
            </div>
        </div>

        <!-- 协议确认 -->
        <div class="form-card">
            <div class="form-group" style="display: flex; align-items: flex-start;">
                <input type="checkbox" id="agreeCheck" style="margin-right: 10px; margin-top: 3px;">
                <label for="agreeCheck" style="font-size: 14px; color: #666;">
                    我已阅读并同意
                    <a href="#" style="color: #0f4c81;">《借款协议》</a>、
                    <a href="#" style="color: #0f4c81;">《个人信息授权书》</a>
                    及其他相关协议
                </label>
            </div>
        </div>

        <!-- 操作按钮 -->
        <button class="btn" id="submitBtn">立即申请</button>
        <button class="btn btn-secondary" id="backBtn">返回</button>
    </div>

    <!-- 底部导航 -->
    <div class="nav">
        <a href="/loan_APP_real/index.html" class="nav-item">
            <i class="fas fa-home"></i>
            <span>首页</span>
        </a>
        <a href="/loan_APP_real/loan.html" class="nav-item">
            <i class="fas fa-money-bill-wave"></i>
            <span>贷款</span>
        </a>
        <a href="/loan_APP_real/message.html" class="nav-item">
            <i class="fas fa-bell"></i>
            <span>消息</span>
        </a>
        <a href="/loan_APP_real/mine.html" class="nav-item">
            <i class="fas fa-user"></i>
            <span>我的</span>
        </a>
    </div>
</div>

<script>
    // 全局变量
    let currentProducts = [];
    let currentProduct = null;

    // 更新当前时间
    function updateTime() {
        const now = new Date();
        const hours = now.getHours().toString().padStart(2, '0');
        const minutes = now.getMinutes().toString().padStart(2, '0');
        document.querySelector('.welcome-text').textContent = `${hours}:${minutes} 借贷`;
    }

    // 格式化利率显示
    function formatRate(rate) {
        return (parseFloat(rate) * 100).toFixed(2) + '%';
    }

    // 格式化金额显示
    function formatAmount(amount) {
        const num = parseFloat(amount);
        if (num >= 10000) {
            return (num / 10000).toFixed(1) + '万';
        }
        return num.toLocaleString() + '元';
    }

    // 获取贷款产品数据
    async function fetchLoanProducts() {
        const container = document.getElementById('products-container');

        try {
            // 从localStorage获取token
            const authData = localStorage.getItem('authData');
            if (!authData) {
                throw new Error('未找到认证信息，请重新登录');
            }

            const token = JSON.parse(authData).accessToken;
            if (!token) {
                throw new Error('认证令牌无效，请重新登录');
            }

            // 设置请求头
            const myHeaders = new Headers();
            myHeaders.append("Authorization", token);

            const requestOptions = {
                method: 'GET',
                headers: myHeaders,
                redirect: 'follow'
            };

            // 发送请求
            const response = await fetch("http://115.190.40.44:45444/loan/option", requestOptions);

            if (!response.ok) {
                throw new Error(`请求失败: ${response.status} ${response.statusText}`);
            }

            const result = await response.json();

            // 检查响应是否成功
            if (!result.success) {
                throw new Error(`API错误: ${result.errCode}`);
            }

            // 保存产品数据
            currentProducts = result.products || [];

            // 清空容器并显示产品
            container.innerHTML = '';

            if (currentProducts.length === 0) {
                container.innerHTML = '<div class="error-message">暂无贷款产品</div>';
                return;
            }

            // 生成产品卡片
            currentProducts.forEach(product => {
                const productCard = document.createElement('div');
                productCard.className = 'product-card';

                // 产品名称
                const title = document.createElement('div');
                title.className = 'product-title';
                title.textContent = product.name;

                // 额度信息
                const amountInfo = document.createElement('div');
                amountInfo.className = 'product-info';
                amountInfo.textContent = `额度 ${formatAmount(product.min_principle)}-${formatAmount(product.max_principle)}`;

                // 利率信息
                const rateInfo = document.createElement('div');
                rateInfo.className = 'product-info';
                rateInfo.innerHTML = `年化利率 <span class="product-rate">${formatRate(product.interest)}起</span>`;

                // 期限信息
                const termInfo = document.createElement('div');
                termInfo.className = 'product-info';

                if (product.min_periods && product.max_periods) {
                    let periodUnit = '个月';
                    if (product.period_type === 'DAY') {
                        periodUnit = '天';
                    } else if (product.period_type === 'YEAR') {
                        periodUnit = '年';
                    }
                    termInfo.textContent = `期限 ${product.min_periods}-${product.max_periods}${periodUnit}`;
                } else {
                    termInfo.textContent = '期限 灵活可选';
                }

                // 逾期利率
                const penaltyInfo = document.createElement('div');
                penaltyInfo.className = 'product-info';
                penaltyInfo.innerHTML = `逾期利率 <span class="product-term">${formatRate(product.penalty)}</span>`;

                // 申请按钮
                const applyBtn = document.createElement('button');
                applyBtn.className = 'btn';
                applyBtn.textContent = '立即申请';
                applyBtn.onclick = function() {
                    applyForLoan(product.id);
                };

                // 最高额度标签
                const amountTag = document.createElement('div');
                amountTag.className = 'product-amount';
                amountTag.textContent = formatAmount(product.max_principle);

                // 组装产品卡片
                productCard.appendChild(title);
                productCard.appendChild(amountInfo);
                productCard.appendChild(rateInfo);
                productCard.appendChild(termInfo);
                productCard.appendChild(penaltyInfo);
                productCard.appendChild(applyBtn);
                productCard.appendChild(amountTag);

                container.appendChild(productCard);
            });

        } catch (error) {
            console.error('获取贷款产品失败:', error);
            container.innerHTML = `<div class="error-message">加载失败: ${error.message}</div>`;
        }
    }

    // 申请贷款
    function applyForLoan(productId) {
        // 检查是否已实名认证
        const isFaceRec = localStorage.getItem('is_face_rec');

        if (isFaceRec === 'true') {
            // 找到选中的产品
            currentProduct = currentProducts.find(p => p.id == productId);

            if (currentProduct) {
                // 切换到详情页面
                document.getElementById('product-list-page').style.display = 'none';
                document.getElementById('loan-detail-page').style.display = 'block';

                // 初始化详情页面
                initLoanDetailPage();
            } else {
                alert('未找到产品信息');
            }
        } else {
            // 跳转到实名认证页面
            window.location.href = '../实名认证.html';
        }
    }

    // 初始化贷款详情页面
    function initLoanDetailPage() {
        if (!currentProduct) return;

        // 设置产品基本信息
        document.getElementById('detail-product-name').textContent = currentProduct.name;
        document.getElementById('detail-product-desc').textContent = currentProduct.info || '极速审批，最快30秒放款';
        document.getElementById('interestRate').value = formatRate(currentProduct.interest);

        // 设置还款方式
        const repayTypeText = getRepayTypeText(currentProduct.repay_type);
        document.getElementById('repayType').value = repayTypeText;

        // 设置金额范围
        const loanAmountInput = document.getElementById('loanAmount');
        loanAmountInput.min = currentProduct.min_principle;
        loanAmountInput.max = currentProduct.max_principle;
        loanAmountInput.value = currentProduct.min_principle;

        document.getElementById('min-amount-hint').textContent = `最低${formatAmount(currentProduct.min_principle)}`;
        document.getElementById('max-amount-hint').textContent = `最高${formatAmount(currentProduct.max_principle)}`;

        // 设置期限选项
        const termOptionsContainer = document.getElementById('term-options-container');
        termOptionsContainer.innerHTML = '';

        if (currentProduct.min_periods && currentProduct.max_periods) {
            let periodUnit = '个月';
            if (currentProduct.period_type === 'DAY') {
                periodUnit = '天';
            } else if (currentProduct.period_type === 'YEAR') {
                periodUnit = '年';
            }

            // 生成期限选项
            for (let i = currentProduct.min_periods; i <= currentProduct.max_periods; i++) {
                if (i <= 12 || i % 6 === 0) { // 限制选项数量，避免过多
                    const termOption = document.createElement('div');
                    termOption.className = 'term-option';
                    termOption.textContent = i + periodUnit;
                    termOption.dataset.periods = i;

                    termOption.addEventListener('click', function() {
                        document.querySelectorAll('.term-option').forEach(opt => opt.classList.remove('active'));
                        this.classList.add('active');
                        updateRepaymentPlan();
                    });

                    termOptionsContainer.appendChild(termOption);
                }
            }

            // 默认选中第一个
            if (termOptionsContainer.firstChild) {
                termOptionsContainer.firstChild.classList.add('active');
            }
        } else {
            // 如果没有期限范围，使用默认选项
            const defaultTerms = [3, 6, 12, 24];
            defaultTerms.forEach(term => {
                const termOption = document.createElement('div');
                termOption.className = 'term-option';
                termOption.textContent = term + '个月';
                termOption.dataset.periods = term;

                termOption.addEventListener('click', function() {
                    document.querySelectorAll('.term-option').forEach(opt => opt.classList.remove('active'));
                    this.classList.add('active');
                    updateRepaymentPlan();
                });

                termOptionsContainer.appendChild(termOption);
            });

            // 默认选中第一个
            termOptionsContainer.firstChild.classList.add('active');
        }

        // 设置产品特色
        const featuresContainer = document.getElementById('product-features');
        featuresContainer.innerHTML = '';

        // 添加宽限期信息
        if (currentProduct.grace_term) {
            const graceFeature = document.createElement('div');
            graceFeature.className = 'product-feature';
            graceFeature.innerHTML = `<i class="fas fa-calendar-check"></i> ${currentProduct.grace_term}期内免息`;
            featuresContainer.appendChild(graceFeature);
        }

        // 添加逾期宽限信息
        if (currentProduct.grace_day) {
            const graceDayFeature = document.createElement('div');
            graceDayFeature.className = 'product-feature';
            graceDayFeature.innerHTML = `<i class="fas fa-shield-alt"></i> 逾期${currentProduct.grace_day}天内免罚息`;
            featuresContainer.appendChild(graceDayFeature);
        }

        // 添加逾期利率信息
        if (currentProduct.penalty) {
            const penaltyFeature = document.createElement('div');
            penaltyFeature.className = 'product-feature';
            penaltyFeature.innerHTML = `<i class="fas fa-exclamation-triangle"></i> 逾期利率 ${formatRate(currentProduct.penalty)}`;
            featuresContainer.appendChild(penaltyFeature);
        }

        // 添加还款方式信息
        const repayFeature = document.createElement('div');
        repayFeature.className = 'product-feature';
        repayFeature.innerHTML = `<i class="fas fa-undo"></i> 还款方式: ${repayTypeText}`;
        featuresContainer.appendChild(repayFeature);

        // 初始化还款计划
        updateRepaymentPlan();

        // 设置事件监听
        loanAmountInput.addEventListener('input', updateRepaymentPlan);
        loanAmountInput.addEventListener('blur', function() {
            const value = parseFloat(this.value) || 0;
            if (value < currentProduct.min_principle) this.value = currentProduct.min_principle;
            if (value > currentProduct.max_principle) this.value = currentProduct.max_principle;
            updateRepaymentPlan();
        });

        // 返回按钮事件
        document.getElementById('backBtn').addEventListener('click', function() {
            document.getElementById('product-list-page').style.display = 'block';
            document.getElementById('loan-detail-page').style.display = 'none';
        });

        // 提交按钮事件
        document.getElementById('submitBtn').addEventListener('click', submitApplication);
    }

    // 获取还款方式文本
    function getRepayTypeText(repayType) {
        switch(repayType) {
            case 'EQUAL_PRINCIPAL':
                return '等额本金';
            case 'EQUAL_INSTALLMENT':
                return '等额本息';
            case 'BALLOON':
                return '气球贷';
            case 'INTEREST_ONLY':
                return '先息后本';
            default:
                return '等额本息';
        }
    }

    // 更新还款计划
    function updateRepaymentPlan() {
        if (!currentProduct) return;

        const amount = parseFloat(document.getElementById('loanAmount').value) || 0;
        const activeTermOption = document.querySelector('.term-option.active');
        if (!activeTermOption) return;

        const term = parseInt(activeTermOption.dataset.periods);
        const annualRate = parseFloat(currentProduct.interest) * 100; // 转换为百分比
        const monthlyRate = annualRate / 12 / 100; // 月利率

        // 等额本息计算公式
        const monthlyPayment = amount * monthlyRate * Math.pow(1 + monthlyRate, term) /
            (Math.pow(1 + monthlyRate, term) - 1);
        const totalRepayment = monthlyPayment * term;
        const totalInterest = totalRepayment - amount;

        // 更新显示
        document.getElementById('repaymentAmount').textContent = formatAmount(amount);
        document.getElementById('repaymentTerm').textContent = term + '个月';
        document.getElementById('monthlyRate').textContent = (monthlyRate * 100).toFixed(4) + '%';
        document.getElementById('monthlyPayment').textContent = formatAmount(monthlyPayment);
        document.getElementById('totalInterest').textContent = formatAmount(totalInterest);
        document.getElementById('totalRepayment').textContent = formatAmount(totalRepayment);
    }

    // 提交申请
    function submitApplication() {
        if (!currentProduct) return;

        const amount = parseFloat(document.getElementById('loanAmount').value) || 0;
        const activeTermOption = document.querySelector('.term-option.active');
        if (!activeTermOption) return;

        const term = parseInt(activeTermOption.dataset.periods);
        const agreed = document.getElementById('agreeCheck').checked;

        // 简单验证
        if (amount < currentProduct.min_principle || amount > currentProduct.max_principle) {
            alert(`请输入${formatAmount(currentProduct.min_principle)}-${formatAmount(currentProduct.max_principle)}之间的贷款金额`);
            return;
        }

        if (term < currentProduct.min_periods || term > currentProduct.max_periods) {
            alert(`期限必须在${currentProduct.min_periods}-${currentProduct.max_periods}个月内`);
            return;
        }

        if (!agreed) {
            alert('请阅读并同意相关协议');
            return;
        }

        // 构建提交数据
        const formData = {
            productId: currentProduct.id,
            amount: amount,
            termCount: term
        };

        // 从localStorage获取token
        const authDataStr = localStorage.getItem('authData');
        const authData = JSON.parse(authDataStr);

        if (!authData || !authData.accessToken) {
            alert('认证信息无效，请重新登录');
            return;
        }

        // 设置请求头
        const myHeaders = new Headers();
        myHeaders.append("Authorization", authData.accessToken);
        myHeaders.append("Content-Type", "application/json");

        const requestOptions = {
            method: 'POST',
            headers: myHeaders,
            redirect: 'follow',
            body: JSON.stringify(formData)
        };

        // 发送申请请求
        fetch("http://115.190.40.44:45444/loan/loan", requestOptions)
            .then(response => response.text())
            .then(result => {
                console.log(result);
                try {
                    const data = JSON.parse(result);
                    if (data.success) {
                        alert('申请提交成功！');
                        // 发送广播消息
                        addNewMessage();
                        // 跳转到消息页面
                        window.location.href = "message.html";
                    } else {
                        alert('提交失败: ' + (data.message || '未知错误'));
                    }
                } catch (e) {
                    console.error('解析响应失败:', e);
                    alert('提交成功！');
                }
            })
            .catch(error => {
                console.log('error', error);
                alert('网络错误，请稍后重试');
            });
    }

    // 发送广播消息
    function addNewMessage() {
        // 模拟发送广播消息
        console.log("发送借款申请成功消息");
        // 实际实现中这里会使用BroadcastChannel或其他方式发送消息
    }

    // 页面加载完成后执行
    document.addEventListener('DOMContentLoaded', function() {
        updateTime();
        setInterval(updateTime, 60000);

        // 获取贷款产品数据
        fetchLoanProducts();

        // 筛选功能交互
        const filterItems = document.querySelectorAll('.filter-item');
        filterItems.forEach(item => {
            item.addEventListener('click', () => {
                filterItems.forEach(i => i.classList.remove('active'));
                item.classList.add('active');
                // 预留接口：根据筛选条件加载不同贷款产品
            });
        });
    });
</script>
</body>
</html>